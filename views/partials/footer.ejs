    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      (function () {
        // EÄŸer user yoksa (login deÄŸilse) balona basÄ±nca /giris'e gÃ¶nder
        const isLoggedIn = <%= user ? 'true' : 'false' %>;
        const userId = <%= user ? user.id : 'null' %>;
        const username = "<%= user ? user.username : '' %>";
        const role = "<%= user ? user.role : '' %>";
        const displayName = "<%= user ? (user.display_name || user.username) : '' %>";

        // UI oluÅŸtur
        const bubble = document.createElement('div');
        bubble.id = 'chat-bubble';
        bubble.innerHTML = 'ðŸ’¬';
        bubble.style.cssText = `
          position: fixed;
          right: 18px;
          bottom: 18px;
          width: 56px;
          height: 56px;
          border-radius: 50%;
          background: var(--gold);
          color: #111;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          z-index: 9999;
          box-shadow: 0 10px 30px rgba(0,0,0,0.35);
          font-weight: 900;
          user-select: none;
        `;

        const dock = document.createElement('div');
        dock.id = 'chat-dock';
        dock.style.cssText = `
          position: fixed;
          right: 18px;
          bottom: 86px;
          width: min(380px, calc(100vw - 36px));
          height: 520px;
          background: rgba(10,10,14,0.92);
          border: 1px solid rgba(212,175,55,0.35);
          border-radius: 16px;
          z-index: 9999;
          display: none;
          overflow: hidden;
          box-shadow: 0 18px 60px rgba(0,0,0,0.55);
          backdrop-filter: blur(8px);
        `;

        dock.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom: 1px solid rgba(212,175,55,0.25);">
            <div style="font-weight:900; color: var(--gold);">CanlÄ± Sohbet</div>
            <div style="display:flex; gap:8px; align-items:center;">
              <a href="/chat" style="font-size:12px; color:#ddd; text-decoration:none; opacity:0.9;">Tam ekran</a>
              <button id="chat-close" class="glass-btn" style="padding:6px 10px;">Kapat</button>
            </div>
          </div>

          <div id="dock-messages" style="height: 392px; overflow-y:auto; padding: 12px; display:flex; flex-direction:column; gap:10px;"></div>

          <form id="dock-form" style="display:flex; gap:10px; padding: 12px; border-top: 1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.25);">
            <input id="dock-input" placeholder="Mesaj yaz..." style="flex:1; padding: 10px 12px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; color: #fff; outline:none;">
            <button class="glass-btn" style="background: var(--gold); color: #111; font-weight:900;">GÃ¶nder</button>
          </form>
        `;

        document.body.appendChild(bubble);
        document.body.appendChild(dock);

        const closeBtn = dock.querySelector('#chat-close');
        const form = dock.querySelector('#dock-form');
        const input = dock.querySelector('#dock-input');
        const msgBox = dock.querySelector('#dock-messages');

        function toggleDock(force) {
          const open = (dock.style.display !== 'none');
          const next = (typeof force === 'boolean') ? force : !open;
          dock.style.display = next ? 'block' : 'none';
        }

        bubble.addEventListener('click', () => {
          if (!isLoggedIn) {
            window.location.href = '/giris';
            return;
          }
          toggleDock();
        });

        closeBtn.addEventListener('click', () => toggleDock(false));

        // Socket baÄŸlan
        let socket;
        function ensureSocket() {
          if (socket) return socket;
          socket = io();

          socket.on('chat message', (data) => {
            addMessage(data, false);
          });

          socket.on('message deleted', (data) => {
            const el = msgBox.querySelector('[data-mid="' + data.id + '"]');
            if (el) el.remove();
          });

          return socket;
        }

        function addMessage(data, isLocal) {
          const wrap = document.createElement('div');
          const mine = data.username === username;

          wrap.dataset.mid = data.id || '';
          wrap.style.cssText = `
            padding: 10px 12px;
            border-radius: 12px;
            max-width: 85%;
            border: 1px solid ${mine ? 'rgba(212,175,55,0.8)' : 'rgba(255,255,255,0.12)'};
            background: ${mine ? 'rgba(212,175,55,0.10)' : 'rgba(255,255,255,0.05)'};
            align-self: ${mine ? 'flex-end' : 'flex-start'};
          `;

          const name = document.createElement('div');
          name.style.cssText = `font-weight:900; font-size:12px; margin-bottom:6px;`;
          name.textContent = (data.displayName || data.username || 'KullanÄ±cÄ±');

          if (data.role === 'admin') {
            name.style.color = 'var(--gold)';
            name.style.textShadow = '0 0 6px rgba(212,175,55,0.6)';
          } else if (data.role === 'moderator') {
            name.style.color = '#ff4d4d';
          } else {
            name.style.color = '#ddd';
          }

          const text = document.createElement('div');
          text.style.cssText = `color:#fff; font-size:14px; line-height:1.35; white-space:pre-wrap; word-break:break-word;`;
          text.textContent = data.text || '';

          wrap.appendChild(name);
          wrap.appendChild(text);
          msgBox.appendChild(wrap);
          msgBox.scrollTop = msgBox.scrollHeight;
        }

        form.addEventListener('submit', (e) => {
          e.preventDefault();
          if (!isLoggedIn) {
            window.location.href = '/giris';
            return;
          }
          const text = (input.value || '').trim();
          if (!text) return;

          ensureSocket().emit('chat message', {
            text,
            userId,
            username,
            role,
            displayName,
            replyToId: null
          });

          input.value = '';
        });
      })();
    </script>

    <script src="/js/main.js"></script>
</body>
</html>
